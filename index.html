<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JIMMY JACK PUREQ -  Gestor Tax√≠metro Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --verde: #27ae60; --rojo: #e74c3c; --oscuro: #2c3e50; --azul: #3498db; --naranja: #f39c12; }
        
        /* BLOQUEO DE MOVIMIENTO DE P√ÅGINA */
        html, body { 
            overflow: hidden; 
            height: 100%; 
            width: 100%; 
            position: fixed; 
            margin: 0; 
            padding: 0;
            touch-action: manipulation;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #f0f2f5; 
            display: flex; 
            justify-content: center; 
        }

        .tarjeta { 
            background: rgba(206, 164, 189, 0.73); 
            padding: 15px; 
            width: 100%; 
            max-width: 480px; 
            height: 100vh; /* Ocupa toda la pantalla sin moverse */
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box;
        }
        
        /* Contenedor que s√≠ permite scroll solo donde hay datos */
        .scroll-interno {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .nav-periodos { display: flex; justify-content: space-around; border-bottom: 1px solid #eee; margin-bottom: 10px; flex-shrink: 0; }
        .tab-btn { padding: 10px 5px; border: none; background: none; font-size: 16px; color: #777; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--verde); border-bottom-color: var(--verde); font-weight: bold; }

        .balance-card { background: var(--oscuro); color: white; padding: 15px; border-radius: 25px; text-align: center; margin-bottom: 10px; flex-shrink: 0; }
        #saldo { font-size: 28px; font-weight: bold; }

        .btn-gps { width: 100%; padding: 12px; border-radius: 15px; border: none; color: white; font-weight: bold; font-size: 16px; margin-bottom: 10px; cursor: pointer; flex-shrink: 0; }

        .seccion-graficos { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .caja-grafico { position: relative; background: #fff; padding: 5px; border-radius: 20px; height: 180px; border: 2px solid #eee; text-align: center; }
        .texto-centro { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }

        .contenedor-cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .cat-chip { background: #f0f2f5; padding: 8px 15px; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 14px; border: 2px solid transparent; }
        .cat-chip.activa { border-color: var(--azul); background: #e8f4fd; color: var(--azul); }

        .metodos-pago { display: flex; gap: 5px; margin-bottom: 10px; flex-shrink: 0; }
        .metodo-btn { flex: 1; padding: 10px; border-radius: 12px; border: 1px solid #ddd; background: #fff; font-size: 11px; font-weight: bold; cursor: pointer; }
        .metodo-btn.active { border-color: var(--azul); background: #e8f4fd; color: var(--azul); }

        .fila { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; flex-shrink: 0; }
        input { padding: 12px; border-radius: 12px; border: 1px solid #ddd; flex: 1; font-size: 18px; outline: none; min-width: 0; }
        
        /* TAMA√ëO DE CASILLEROS PARA QUE NO SE SALGAN */
        .input-auto { background: #fffdf0; border-color: var(--naranja); font-weight: bold; color: var(--naranja); flex: 1; max-width: 48%; }

        .btn-accion { flex: 1; padding: 15px; border: none; border-radius: 120px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        
        .historial { margin-top: 10px; border-top: 1px solid #eee; }
        .item { background: #fff; padding: 12px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        #modal, #modal-mes, #modal-semana, #modal-anio { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:100; }
        .modal-content { background:rgb(86, 172, 226); padding:25px; border-radius:25px; width:90%; max-width:400px; color: white; text-align: center; }

        .grid-meses { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .btn-mes { padding: 10px; border: none; border-radius: 10px; background: rgba(255,255,255,0.2); color: white; font-weight: bold; cursor: pointer; }
        .btn-mes.active { background: var(--verde); }
        .selector-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 10px; }
        .nav-btn { background: none; border: none; color: white; font-size: 30px; cursor: pointer; }
    </style>
    </head>
    <body onload="inicializar()">
    
    <div class="tarjeta">
        <div class="nav-periodos">
            <button class="tab-btn active" onclick="cambiarPeriodo('dia', this)">D√≠a</button>
            <button class="tab-btn" onclick="cambiarPeriodo('semana', this)">Semana</button>
            <button class="tab-btn" onclick="cambiarPeriodo('mes', this)">Mes</button>
            <button class="tab-btn" onclick="cambiarPeriodo('anio', this)">A√±o</button>
        </div>
        
    <div class="balance-card">
        <small style="opacity: 0.8;">JIMMY JACK PUREQ - Gestor/Tax√≠metro Pro</small><br>
        <span id="saldo">S/. 0.00</span>
    </div>

    <div class="scroll-interno">
        <button id="btn-gps" class="btn-gps" style="background: var(--naranja);" onclick="toggleSeguimiento()">üöÄ INICIAR TURNO (GPS)</button>

        <div class="seccion-graficos">
            <div class="caja-grafico">
                <div class="texto-centro">
                    <small style="color: var(--verde); font-weight: bold;">INGRESOS</small><br>
                    <span id="txt-total-ing" style="font-size: 20px; font-weight: bold; color: var(--oscuro);">S/. 0.00</span>
                </div>
                <canvas id="cIng"></canvas>
            </div>
            <div class="caja-grafico">
                <div class="texto-centro">
                    <small style="color: var(--rojo); font-weight: bold;">GASTOS</small><br>
                    <span id="txt-total-gas" style="font-size: 20px; font-weight: bold; color: var(--oscuro);">S/. 0.00</span>
                </div>
                <canvas id="cGas"></canvas>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:10px;">
            <input type="date" id="input-fecha-filtro" onchange="actualizarInterfaz()" style="border:none; background:transparent; font-weight:bold;">
            <div id="visor-semana" onclick="abrirModalSemana()" style="display:none; cursor:pointer; font-weight:bold;">üóìÔ∏è <span id="txt-semana">Semana</span></div>
            <div id="visor-mes" onclick="abrirModalMes()" style="display:none; cursor:pointer; font-weight:bold;">üìÖ <span id="txt-mes">Mes</span></div>
            <div id="visor-anio" onclick="abrirModalAnio()" style="display:none; cursor:pointer; font-weight:bold;">‚≠ê <span id="txt-anio">A√±o</span></div>
        </div>

        <div class="contenedor-cats" id="cat-chips"></div>

        <div class="metodos-pago">
            <button class="metodo-btn active" onclick="setMetodo('Efectivo', 'üíµ', this)">üíµ Efectivo</button>
            <button class="metodo-btn" onclick="setMetodo('Yape', 'üü£', this)">üü£ Yape</button>
            <button class="metodo-btn" onclick="setMetodo('Tarjeta', 'üí≥', this)">üí≥ Tarjeta</button>
        </div>

        <div class="fila">
            <input type="number" id="monto" placeholder="S/. Monto">
            <button onclick="abrirModal()" style="border-radius:12px; border:none; padding:12px; background:#ddd;">‚öôÔ∏è</button>
        </div>

        <div class="fila">
            <input type="number" id="km" class="input-auto" placeholder="0.00 KM" step="0.01">
            <input type="number" id="hrs" class="input-auto" placeholder="0.00 Horas" step="0.01">
        </div>
        
        <div class="fila">
            <button class="btn-accion" style="background:var(--verde)" onclick="registrar('ingreso')">Ingreso +</button>
            <button class="btn-accion" style="background:var(--rojo)" onclick="registrar('gasto')">Gasto -</button>
        </div>

        <div id="lista" class="historial"></div>
    </div>
</div>

<div id="modal"><div class="modal-content">
    <h3>Categor√≠as</h3>
    <div id="lista-gestion" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>
    <div class="fila"><input type="text" id="n-ico" placeholder="Emoji" style="flex:0.3"><input type="text" id="n-nom" placeholder="Nombre"><button onclick="crearCat()" style="padding:15px; background:var(--verde); color:white; border:none; border-radius:12px;">+</button></div>
    <button onclick="cerrarModal()" style="width:100%; margin-top:15px; padding:15px; background:var(--oscuro); color:white; border-radius:12px; border:none; font-weight:bold;">Cerrar</button>
</div></div>

<div id="modal-semana"><div class="modal-content">
    <h3>Navegar Semanas</h3>
    <div class="selector-nav">
        <button class="nav-btn" onclick="navegarSemana(-7)">‚óÄ</button>
        <div id="rango-semana-modal" style="font-weight:bold;">--</div>
        <button class="nav-btn" onclick="navegarSemana(7)">‚ñ∂</button>
    </div>
    <button onclick="document.getElementById('modal-semana').style.display='none'" style="width:100%; margin-top:20px; padding:12px; background:white; color:var(--azul); border:none; border-radius:12px; font-weight:bold;">OK</button>
</div></div>

<div id="modal-mes"><div class="modal-content">
    <h3>Seleccionar Mes</h3>
    <div id="grid-meses" class="grid-meses"></div>
    <button onclick="document.getElementById('modal-mes').style.display='none'" style="width:100%; margin-top:20px; padding:12px; background:white; color:var(--azul); border:none; border-radius:12px; font-weight:bold;">Cerrar</button>
</div></div>

<div id="modal-anio"><div class="modal-content">
    <h3>Navegar A√±o</h3>
    <div class="selector-nav">
        <button class="nav-btn" onclick="navegarAnio(-1)">‚óÄ</button>
        <div id="txt-anio-modal" style="font-size:24px; font-weight:bold;">2026</div>
        <button class="nav-btn" onclick="navegarAnio(1)">‚ñ∂</button>
    </div>
    <button onclick="document.getElementById('modal-anio').style.display='none'" style="width:100%; margin-top:20px; padding:12px; background:white; color:var(--azul); border:none; border-radius:12px; font-weight:bold;">OK</button>
</div></div>

<script>
    Chart.register(ChartDataLabels);
    let movs = JSON.parse(localStorage.getItem('movs_v15')) || [];
    let cats = JSON.parse(localStorage.getItem('cats_v15')) || [{id: 0, n: "Carrera", i: "üöï"}, {id: 1, n: "Gasolina", i: "‚õΩ"}, {id: 2, n: "Comida", i: "üçî"}];
    let catSeleccionada = cats[0].id, metodoActual = { n: 'Efectivo', i: 'üíµ' }, periodoActual = 'dia';
    let fRefSemana = new Date(), mesFiltro = new Date().getMonth(), anioFiltro = new Date().getFullYear();
    let cIng, cGas, watchId = null, latAnt = null, lonAnt = null, distTotal = 0, tInicio = null, activo = false;
    const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    function inicializar() {
        document.getElementById('input-fecha-filtro').value = new Date().toLocaleDateString('en-CA', {timeZone: 'America/Lima'});
        dibujarCats(); initCharts(); actualizarInterfaz();
    }

    function toggleSeguimiento() {
        const btn = document.getElementById('btn-gps');
        if (!activo) {
            distTotal = 0; tInicio = new Date(); latAnt = null; lonAnt = null;
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(actualizarGPS, null, { enableHighAccuracy: true });
                activo = true; btn.innerText = "üõë FINALIZAR TURNO"; btn.style.background = "#7f8c8d";
            }
        } else {
            const tFinal = new Date(), diffMs = tFinal - tInicio, totalHoras = (diffMs / 3600000).toFixed(2);
            if (distTotal > 0.01) {
                let montoAuto = prompt(`RESUMEN:\nüöó ${distTotal.toFixed(2)} km\n‚è±Ô∏è ${totalHoras} hrs\n\n¬øCobro?`);
                if (montoAuto) { document.getElementById('monto').value = montoAuto; registrar('ingreso'); }
            }
            navigator.geolocation.clearWatch(watchId); activo = false; btn.innerText = "üöÄ INICIAR TURNO (GPS)"; btn.style.background = "var(--naranja)";
            document.getElementById('km').value = ""; document.getElementById('hrs').value = "";
        }
    }

    function actualizarGPS(pos) {
        if (latAnt && lonAnt) {
            const R = 6371, dLat = (pos.coords.latitude - latAnt) * Math.PI / 180, dLon = (pos.coords.longitude - lonAnt) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(latAnt*Math.PI/180)*Math.cos(pos.coords.latitude*Math.PI/180)*Math.sin(dLon/2)**2;
            distTotal += R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            document.getElementById('km').value = distTotal.toFixed(2);
        }
        latAnt = pos.coords.latitude; lonAnt = pos.coords.longitude;
        let ms = new Date() - tInicio;
let hh = Math.floor(ms / 3600000);
let mm = Math.floor((ms % 3600000) / 60000);
document.getElementById('hrs').value = `${hh}h ${mm}m`;}

    function registrar(tipo) {
        const mon = parseFloat(document.getElementById('monto').value);
        if (mon >= 0) {
            const catObj = cats.find(c => c.id === catSeleccionada);
            const ahora = new Date();
            movs.unshift({ mon, tipo, catN: catObj.n, catI: catObj.i, km: document.getElementById('km').value || 0, hrs: document.getElementById('hrs').value || 0, metodoN: metodoActual.n, metodoI: metodoActual.i, fecha: ahora.toISOString(), hora: ahora.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit', hour12:false}) });
            localStorage.setItem('movs_v15', JSON.stringify(movs));
            document.getElementById('monto').value = ''; actualizarInterfaz();
        }
    }

    function actualizarInterfaz() {
        const listaUI = document.getElementById('lista'), fFiltro = document.getElementById('input-fecha-filtro').value;
        const ahora = new Date(), rangoSem = getRangoSemana(fRefSemana);
        document.getElementById('txt-semana').innerText = rangoSem.texto;
        document.getElementById('rango-semana-modal').innerText = rangoSem.texto;
        document.getElementById('txt-mes').innerText = nombresMeses[mesFiltro] + " " + anioFiltro;
        document.getElementById('txt-anio').innerText = anioFiltro;
        document.getElementById('txt-anio-modal').innerText = anioFiltro;

        let dIng = {}, dGas = {}; listaUI.innerHTML = '';
        movs.forEach((m, index) => {
            const fM = new Date(m.fecha); let incluir = false;
            if (periodoActual === 'dia') incluir = (fM.toLocaleDateString('en-CA') === fFiltro);
            else if (periodoActual === 'semana') incluir = (fM >= rangoSem.inicio && fM <= rangoSem.fin);
            else if (periodoActual === 'mes') incluir = (fM.getMonth() === mesFiltro && fM.getFullYear() === anioFiltro);
            else if (periodoActual === 'anio') incluir = (fM.getFullYear() === anioFiltro);

            if (incluir && m.metodoN === metodoActual.n) {
                const esI = m.tipo === 'ingreso';
                if (esI) dIng[m.catN] = (dIng[m.catN] || 0) + m.mon; else dGas[m.catN] = (dGas[m.catN] || 0) + m.mon;
                listaUI.innerHTML += `<div class="item" style="border-left-color: ${esI ? 'var(--verde)' : 'var(--rojo)'}">
                    <div><strong>${m.catI} ${m.catN}</strong><br><small>üïí ${m.hora} | ${fM.toLocaleDateString('es-PE',{day:'2-digit',month:'2-digit'})}</small><br><small>üöó ${m.km}km ‚Ä¢ ‚è±Ô∏è ${m.hrs}h</small></div>
                    <div style="text-align: right;"><span style="color:${esI?'var(--verde)':'var(--rojo)'}; font-weight:bold;">S/.${m.mon.toFixed(2)}</span><br><button onclick="editarMovimiento(${index})" style="background:none; border:none; font-size:18px;">‚úèÔ∏è</button><button onclick="eliminarMovimiento(${index})" style="background:none; border:none; font-size:18px; margin-left:10px;">üóëÔ∏è</button></div>
                </div>`;
            }
        });
        const totalI = Object.values(dIng).reduce((a, b) => a + b, 0), totalG = Object.values(dGas).reduce((a, b) => a + b, 0);
        document.getElementById('txt-total-ing').innerText = `S/. ${totalI.toFixed(2)}`;
        document.getElementById('txt-total-gas').innerText = `S/. ${totalG.toFixed(2)}`;
        document.getElementById('saldo').innerText = `S/. ${(totalI - totalG).toFixed(2)}`;
        actualizarCharts(totalI, totalG, dIng, dGas);
    }

    function getRangoSemana(f) {
        let d = new Date(f), day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
        let inicio = new Date(d.setDate(diff)); inicio.setHours(0,0,0,0);
        let fin = new Date(inicio); fin.setDate(inicio.getDate() + 6); fin.setHours(23,59,59,999);
        return { inicio, fin, texto: `${inicio.toLocaleDateString('es-PE',{day:'2-digit',month:'short'})} - ${fin.toLocaleDateString('es-PE',{day:'2-digit',month:'short'})}` };
    }

    function cambiarPeriodo(p, btn) {
        periodoActual = p; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
        document.getElementById('input-fecha-filtro').style.display = (p === 'dia') ? 'inline-block' : 'none';
        document.getElementById('visor-semana').style.display = (p === 'semana') ? 'block' : 'none';
        document.getElementById('visor-mes').style.display = (p === 'mes') ? 'block' : 'none';
        document.getElementById('visor-anio').style.display = (p === 'anio') ? 'block' : 'none';
        actualizarInterfaz();
    }

    function navegarSemana(n) { fRefSemana.setDate(fRefSemana.getDate() + n); actualizarInterfaz(); }
    function navegarAnio(n) { anioFiltro += n; actualizarInterfaz(); }
    function abrirModalSemana() { document.getElementById('modal-semana').style.display = 'flex'; }
    function abrirModalAnio() { document.getElementById('modal-anio').style.display = 'flex'; }
    function abrirModalMes() {
        const g = document.getElementById('grid-meses');
        g.innerHTML = nombresMeses.map((m, i) => `<button class="btn-mes ${i === mesFiltro ? 'active' : ''}" onclick="mesFiltro=${i};document.getElementById('modal-mes').style.display='none';actualizarInterfaz();">${m}</button>`).join('');
        document.getElementById('modal-mes').style.display = 'flex';
    }

    function editarMovimiento(idx) { let nV = prompt("Nuevo monto S/.", movs[idx].mon); if (nV !== null) { movs[idx].mon = parseFloat(nV); localStorage.setItem('movs_v15', JSON.stringify(movs)); actualizarInterfaz(); } }
    function eliminarMovimiento(idx) { if (confirm("¬øEliminar?")) { movs.splice(idx, 1); localStorage.setItem('movs_v15', JSON.stringify(movs)); actualizarInterfaz(); } }
    function setMetodo(n, i, btn) { metodoActual = { n, i }; document.querySelectorAll('.metodo-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); actualizarInterfaz(); }
    function dibujarCats() { document.getElementById('cat-chips').innerHTML = cats.map(c => `<div class="cat-chip ${c.id === catSeleccionada ? 'activa' : ''}" onclick="catSeleccionada=${c.id};dibujarCats();actualizarInterfaz();">${c.i} ${c.n}</div>`).join(''); }
    function initCharts() { const opt = { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, datalabels: { color: '#444', font: { weight: 'bold', size: 10 } } } }; cIng = new Chart(document.getElementById('cIng'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#2ecc71', '#27ae60', '#1abc9c'] }] }, options: opt }); cGas = new Chart(document.getElementById('cGas'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#e74c3c', '#e67e22', '#f1c40f'] }] }, options: opt }); }
    function actualizarCharts(ti, tg, di, dg) { cIng.data.labels = Object.keys(di); cIng.data.datasets[0].data = Object.values(di); cIng.update(); cGas.data.labels = Object.keys(dg); cGas.data.datasets[0].data = Object.values(dg); cGas.update(); }
    function abrirModal() { document.getElementById('modal').style.display = 'flex'; dibujarGestion(); }
    function cerrarModal() { document.getElementById('modal').style.display = 'none'; }
    function dibujarGestion() { document.getElementById('lista-gestion').innerHTML = cats.map((c, i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${c.i} ${c.n}</span><button onclick="cats.splice(${i},1);localStorage.setItem('cats_v15', JSON.stringify(cats));dibujarCats();dibujarGestion();">‚ùå</button></div>`).join(''); }
    function crearCat() { const i = document.getElementById('n-ico').value || "üì¶", n = document.getElementById('n-nom').value; if(n) { cats.push({id: Date.now(), n, i}); localStorage.setItem('cats_v15', JSON.stringify(cats)); dibujarCats(); dibujarGestion(); } }
</script>
</body>
</html>
